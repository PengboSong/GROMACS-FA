# Overview

This documentation is provided for a complete guide of installation and usage of our force decomposition, analysis and visualization program GROMACS-FA. Parts of this documentation is reorganized from our paper and supporting information. For more detailed information about the underlying mechanisms of the programs, please see [LINK HERE](Paper in submitting).

The program of force decomposition, `GROMACS-FA`, is organized into two main components. The first part is the ForceAnal module integrated with GROMACS 2019.3 source codes, named `GROMACS-2019.3-FA`. Source codes of `GROMACS-2019.3-FA` can be obtained at the public repository [GROMACS-2019.3-FA](https://github.com/PengboSong/GROMACS-2019.3-FA/), with full development history. Packages of `GROMACS-2019.3-FA` source codes are also released in this repository under the LGPL-2.1 license. The second part is a program named `readFA` to process and analyze force data generated by above program. Source codes of program `readFA` is provided in this repository under the `READFA` directory.

## Installation Guide

### GROMACS with ForceAnal module

The integrated ForceAnal module of `GROMACS-2019.3-FA` is developed based on GROMACS native framework. Therefore, the installation prerequisites can be checked at [GROMACS 2019.3 Installation Guide](https://manual.gromacs.org/documentation/2019.3/install-guide/index.html).

Please note that the ForceAnal module was unable to support all features of the GROMACS ontology due to lack of development support, especially MPI, SIMD and GPU support. For these reasons, ForceAnal module was integrated to GROMACS rerun procedure only, and should be installed in a restrict way with limited features. It is recommended to install another version of GROMACS with full features. This version without ForceAnal of GROMACS is used for running a standard Molecular Dynamics with fast speed. The produced MD trajectory can be used for force decomposition in a rerun procedure by the version with ForceAnal of GROMACS.

The installation and functionalities of `GROMACS-2019.3-FA` is fully tested under Ubuntu 20.04 LTS with GCC 7.5.0 and CMake 3.14. Newer versions of Ubuntu may have GCC 9.3.0 or 11.4.0 or 13.2.0. However, compile old version of GROMACS like 2019.3 in this case with GCC-11 or GCC-13 cause include errors showing the message `‘numeric_limits’ is not a member of std’`. It is recommended to downgrade higher versions of GCC-11 or GCC-13 to GCC-9 or GCC-7. In Ubuntu systems, version of GCC toolchains can be easily changed by using `update-alternatives` tool. For example, GCC 11.4.0 is installed on Ubuntu 22.04 LTS, GCC 9.3.0 can be installed by `sudo apt install gcc-9 g++-9`. Then adding these two versions to `update-alternatives` tool by:

```sh
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 30 --slave /usr/bin/g++ g++ /usr/bin/g++-9
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 20 --slave /usr/bin/g++ g++ /usr/bin/g++-11
```

The digits in the commands above are priority levels. In this case, GCC-9 is prior to GCC-11 during compilation. Switches between different versions manually are configured via `sudo update-alternatives --config gcc`.

It is recommanded to install GROMACS-FA with the following procedures:

1. Check that installation prerequisites of GROMACS 2019.3 are satisfied.
2. Get and unpack the tarball package of GROMACS-2019.3-FA source codes.
3. Make a separate build directory and change to it.
4. Run `cmake` with options `-DGMX_MPI=OFF`, `-DGMX_SIMD=none` and `-DGMX_GPU=OFF`. A suffix of `_fa` is recommanded to distinguish GROMACS-FA from other versions of GROMACS.
5. Run `make`, `make check` and `make install`. All tests should be passed, integration of ForceAnal has no impact on make tests.
6. Source `GMXRC` to get access to GROMACS commands.

Or simply follow the commands outlined below, step by step:

```sh

tar xvfz gromacs-2019.3-FA.tar.gz
cd gromacs-2019.3-FA
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=$FAROOT/FA \
-DCMAKE_BUILD_TYPE=Release \
-DGMX_DEFAULT_SUFFIX=OFF \
-DGMX_BINARY_SUFFIX=_fa \
-DGMX_MPI=OFF \
-DGMX_SIMD=none \
-DGMX_GPU=OFF \
-DGMX_FFT_LIBRARY=fftw3 \
-DGMX_BUILD_OWN_FFTW=ON
make
make check
make install
source $FAROOT/FA/bin/GMXRC
```

In the commands listed above, a variable of `$FAROOT` is used to specify the root directory of GROMACS-FA installation location. It is recommended to install GROMACS-FA to a standalone directory to avoid confusion.

CAUTION: A build of `GROMACS-2019.3-FA` would also succeed with MPI, SIMD, GPU features. However, force decomposition functions were not designed for these scenarios and would fail without warnings or errors. Please be careful when you are doing a compilation.

### READFA

`readFA` can be compiled from source codes with CMake version 3.1 or later. The working directory of `readFA` contains a `readFA.cpp` file. Then follow the commands listed below:

```sh
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=$READFAROOT \
-DCMAKE_BUILD_TYPE=Release
make
make install
```

The variable used above is used to specify the root directory of `readFA` installation location. The normally functioning of `readFA` program is not dependent on `GROMACS` with `ForceAnal` module, thus can be installed separatedly.

## Usage

An example of p38 MAP kinase in its apo-form (PDB ID: 1R39) is included in the `p38` subdirectory of `examples` directory. The cloning artifact segment of 6 residues was removed from the head, and the unordered segments of 4 residues in the head and 9 residues in the tail were also removed. The missing residue of Ala172-His174 were filled using Protein Preparation Wizard from Schrödinger. Thus the initial conformation of `1r39.gro` has 347 residues with 5598 atoms. A processed conformation with water and ions of `1r39_sol_ions.gro` was also provided, which is recommended for subsequent MD reproducing. The CHARMM36m force field (C36m) and the CHARMM modified TIP3P water models were used for the protein and water molecules, respectively. The topology of `topol.top` (with several itp files referenced by `topol.top`) and a generated index file of `index.ndx` were also provided for reproducing.

It is worth noting that a bundle of files of CHARMM36m force field for GROMACS should be placed in the topology directory. The tarball package is available under [CHARMM36 Files for GROMACS](http://mackerell.umaryland.edu/charmm_ff.shtml#gromacs). Since the topology directories are independent for each versions of GROMACS, copies of force field files should be placed under each topology directories. A better solution might be holding only one copy in one of topology directories, and make soft-links in other topology directories.

### Standard Molecular Dynamics

A standard Molecular Dynamics shoule be prepared first. The process of setting up simulation system and producing MD could follow the official tutorial of GROMACS like the [Lysozyme in Water](www.mdtutorials.com/gmx/lysozyme/index.html) or [Protein-Ligand Complex](http://www.mdtutorials.com/gmx/complex/index.html) examples.

Molecular Dynamics parameters used for producing MD are outlined below:

```log
; Run Control
integrator = md
dt = 0.001 ; 1 fs
nsteps = 100000000 ; 100 ns

; Output Control
nstxout = 10000 ; Output every 10 ps
nstvout = 10000
nstfout = 10000 ; Forces are required for output
nstlog  = 10000

; Neighbor Searching
cutoff-scheme = Verlet
rlist = 1.5 ; rlist is slightly large for better simulation stability
nstlist = 20
ns_type = grid
pbc = xyz
verlet-buffer-tolerance = 0.002 ; Neighbor list update frequency is mainly controlled by this parameter

; Electrostatics
coulombtype = PME
rcoulomb = 1.5
pme-order = 4
fourierspacing = 0.12

; Van der Waals
vdwtype = Cut-off
vdw-modifier = Force-switch
rvdw = 1.2
rvdw-switch = 1.0
DispCorr = EnerPres

; NPT Ensemble
; Temperature Coupling
tcoupl = V-rescale
tc-grps = Protein non-Protein
ref-t = 298 298
tau-t = 0.1 0.1

; Pressure Coupling
pcoupl = Parrinello-Rahman
pcoupltype = isotropic
tau-p = 0.5
ref-p = 1.0
compressibility = 4.6e-05
refcoord_scaling = com
```

Please note that the LINCS algorithm was not applied to constrain the covalent bonds with hydrogens. Though a time step of 1 fs is OK to run on our tests, the time step is suggested to reduce to 0.5 fs for a better sampling of hydrogens.

Forces of the produced MD should be viewed and checked before force decomposition process. Sampling of the protein near its equilibrium state is important for further analysis. Forces can be extracted from the produced MD trajectory with `gmx traj`:

```sh
gmx traj -f 1r39_md.trr \
-s 1r39_md.tpr \
-n index.ndx \
-of 1r39_forces_on_atoms.xvg
```

### Force Decomposition

It is worth mentioning that guidance in this chapter should be the version with ForceAnal of GROMACS. Confusion of GROMACS versions could cause misunderstandings or problems.

Calculation of pairwise components in Ewald summation for long-range electrostatic interactions is supported by ForceAnal, but decomposition of forces in PME is unavailable. Though force decomposition of Ewald summation is supported, it is much slower than other functions of force decomposition depending on the spacing grid parameter. For a typical spacing grid of 0.15 nm, it would be more than 10000x slower than other force decomposition functions. So force decomposition of electrostatics parts were changed to be a plain cut-off method, but on more precise conformations produced with PME method.

Molecular Dynamics parameters used for force decomposition are outlined below:

```log
; Run Control
integrator = md
dt = 0.001 ; 1 fs
nsteps = 100000000 ; 100 ns

; Output Control
nstxout = 10000 ; Output every 10 ps
nstvout = 10000
nstfout = 10000 ; Forces are required for output
nstlog  = 10000

; Neighbor Searching
cutoff-scheme = Verlet
rlist = 1.5 ; rlist is slightly large for better simulation stability
nstlist = 20
ns_type = grid
pbc = xyz
verlet-buffer-tolerance = 0.002 ; Neighbor list update frequency is mainly controlled by this parameter

; Electrostatics
coulombtype = cutoff
rcoulomb = 1.2

; Van der Waals
vdwtype = Cut-off
vdw-modifier = Force-switch
rvdw = 1.2
rvdw-switch = 1.0
DispCorr = EnerPres

; NPT Ensemble
; Temperature Coupling
tcoupl = V-rescale
tc-grps = Protein non-Protein
ref-t = 298 298
tau-t = 0.1 0.1

; Pressure Coupling
pcoupl = Parrinello-Rahman
pcoupltype = isotropic
tau-p = 0.5
ref-p = 1.0
compressibility = 4.6e-05
refcoord_scaling = com
```

Only the electrostatic parameter parts are changed. The system topology should be updated first using `gmx_fa grompp`. Here is an example of the command:

```sh
gmx_fa grompp -f md_changed.mdp \
-c 1r39_md.gro \
-r 1r39_md.gro \
-n index.ndx \
-p topol.top \
-o 1r39_md_fa.tpr
```

The force decomposition is processing during the rerun of produed MD trajectory. Here is an example of the command:

```sh
gmx_fa mdrun -nt 1 \
-rerun 1r39_md.trr \
-s 1r39_md_fa.tpr \
-o 1r39_md_fa.trr \
-c 1r39_md_fa.gro \
-g 1r39_md_fa.log \
-e 1r39_md_fa.edr \
-fo 1r39_md_fa.for \
-fa 1r39_md_fa.far \
-fd 1r39_md_fa_fdev.far \
-fp fa_grps.par \
-fn index.ndx \
-fmp 1r39_md_fa.fmp
```

Several command options in the tail are added by ForceAnal module. Options `-fo`, `-fa`, `-fd` control the output, `-fp` reads configuration parameters for ForceAnal module from the given file, and `-fn` reads index file generated by GROMACS. The option `-fmp` is obsoleted, but a useless file with suffix `.fmp` is still generated during the process. The obsoleted option `-fmp` will be completely removed in the future releases.

In detail, `-fo` option specifies the output filename of pairwise forces data, and no pairwise forces are out without this option. `-fa` and `-fd` are working in the same manner as `-fo`, but control the output of summed forces on atoms or residues and force decomposition deviations accumulated on each atoms, respectively. The `-fp` loads configuration parameters for ForceAnal module, which is written in the same format of GROMACS Molecular Dynamics Parameter (.mdp options) file with distinct options. An example of ForceAnal configuration parameters file read by `-fp` option is shown below:

```log
; Comments start with semicolon
; These 4 options are used for Debug
; Whether to get and output forces on atoms of each frames, default to yes (This should always be the same as forces recorded in trajectory)
summed-force-atom = no
; Whether to output forces on residues of each frames, default to yes
summed-force-residue = no
; Whether to output forces on atoms with only nonbonded components, default to no
summed-force-nonbonded = no
; Whether to output forces on atoms with only bonded & nonbonded components, default to no
summed-force-nonbonded-bonded = no

; First set total number of analysis group pairs, set to 0 will skip the following options and close force decomposition functions
group-pairs = 6

; Protein residue-level internal force network analysis
; Options of each analysis group pair add a prefix as grpX-
; X denotes the index of analysis group pair, starts from 0
; `analmode` here should be one of summed/detailed/list
grp0-analmode   = summed
; `vector` and `scalar` should be `yes` for a analysis by `readFA` program
grp0-vector     = yes
grp0-scalar     = yes
; `threshold` filters pairs with a scalar/norm of pairwise force lower than given value
grp0-threshold  = 1.0E-3
; `forceunit` here should be one of atom/residue/group/system
grp0-forceunitA = residue
grp0-forceunitB = residue
; `group` here should be one of group names specifed by GROMACS index file
grp0-groupA     = Protein
grp0-groupB     = Protein

; Protein residue-level internal force network analysis
; With detailed components from each potential terms (including bonds, polar bonds, angles, dihedrals, 1-4 interactions, coulomb and LJ potentials)
; Components of CMAP correction are included in the dihedrals term
grp1-analmode   = detailed
grp1-vector     = yes
grp1-scalar     = yes
grp1-threshold  = 1.0E-3
grp1-forceunitA = residue
grp1-forceunitB = residue
grp1-groupA     = Protein
grp1-groupB     = Protein

; Protein C-alpha internal force network analysis
grp2-analmode   = summed
grp2-vector     = yes
grp2-scalar     = yes
grp2-threshold  = 1.0E-3
grp2-forceunitA = residue
grp2-forceunitB = residue
grp2-groupA     = C-alpha
grp2-groupB     = Protein

; Protein atom-level total force analysis
grp3-analmode   = summed
grp3-vector     = yes
grp3-scalar     = yes
grp3-threshold  = 1.0E-3
grp3-forceunitA = system
grp3-forceunitB = atom
grp3-groupA     = System
grp3-groupB     = Protein

; Protein atom-level internal force analysis
grp4-analmode   = summed
grp4-vector     = yes
grp4-scalar     = yes
grp4-threshold  = 1.0E-3
grp4-forceunitA = group
grp4-forceunitB = atom
grp4-groupA     = Protein
grp4-groupB     = Protein

; Protein residue-level solvation effect analysis
grp5-analmode   = summed
grp5-vector     = yes
grp5-scalar     = yes
grp5-threshold  = 1.0E-3
grp5-forceunitA = group
grp5-forceunitB = residue
grp5-groupA     = SOL
grp5-groupB     = Protein
```

GROMACS-FA supports setting up multiple analysis group pairs. In each analysis group pairs, force units are used to represent the pairwise force in between. The force units can be atoms, residues, groups, or the whole system. Choosing force units to be groups means including collections of atoms defined by users. For more details, please see supporting information of our paper.

The following information will be printed in the command-line interface during the rerun process:

```log
Write Atom Summed Force = NO
Write Residue Summed Force = NO
Write Nonbonded Summed Force = NO
Write Nonbonded + Bonded Summed Force = NO
Write Force Decomposition Residual Error = YES

Average Frequency = 1
Number of Group Pairs = 1
==*==*== GROUP 0 ==*==*==
Write Text Format Force Data = NO
Write Binary Format Force Data = YES
Force Analysis Mode = SummedMode
Output Data Type = Vector + Scalar
--*-- GROUP A --*--
Group Name = Protein
Force Unit = Residue
Number of Atoms = 5598
Nodes Range = [0,347)
Atom Map Verified = Success

--*-- GROUP B --*--
Group Name = Protein
Force Unit = Residue
Number of Atoms = 5598
Nodes Range = [0,347)
Atom Map Verified = Success
==*==*==*==*==*==*==*==*==

...(Detailed logs of other analyais group pairs are omitted)
```

The detailed configuration of ForceAnal module are listed. The `Node Range` line is important to generate an index map used by `readFA` manually. The `Atom Map Verified` line should always be success to continue the force decomposition process. It is important to double check your parameters are correct.

With all these configurations, output files generated by `ForceAnal` module should include:

- `1r39_md_fa_grpX.for` (X=0~5): Binary data file of pairwise forces for each analysis group pairs.
- `1r39_md_fa_fdev.far`: Binary data file of force decomposition errors on each atoms.
- `1r39_md_fa.fmp`: Deprecated

Note that all 4 debug options are closed, if these options are set to `yes`, output files would also include the following files:

- `1r39_md_fa.far`: Binary file of forces on atoms of each frames
- `1r39_md_fa_res.far`: Binary data file of forces on residues of each frames
- `1r39_md_fa_nb.far`: Binary data file of forces on atoms with only nonbonded components
- `1r39_md_fa_nb+b.far`: Binary data file of forces on atoms with only bonded & nonbonded components

### Force Analysis

#### Preparation Processing

Before processing and analyzing force data from the previous step, several files could be used for `readFA` input. Python scripts used for generating these files can be found in the `scripts` directory.

Index map files are required for two groups in each analysis group pairs. These files are currently generated by using a provided script `genFAMap.py`. It can be easily done by searching the detailed configuration output of ForceAnal module mentioned above. For example, in the output contents taken from the first analysis group pair:

```log
==*==*== GROUP 0 ==*==*==
Write Text Format Force Data = NO
Write Binary Format Force Data = YES
Force Analysis Mode = SummedMode
Output Data Type = Vector + Scalar
--*-- GROUP A --*--
Group Name = Protein
Force Unit = Residue
Number of Atoms = 5598
Nodes Range = [0,347) <- This line is used to generate index map for group A
Atom Map Verified = Success

--*-- GROUP B --*--
Group Name = Protein
Force Unit = Residue
Number of Atoms = 5598
Nodes Range = [0,347) <- This line is used to generate index map for group B
Atom Map Verified = Success
==*==*==*==*==*==*==*==*==
```

You can finding the `Node Range` lines for two groups in blocks of each analysis group pairs. The two numbers enclosed by left bracket and right parenthesis, 0 and 347, show the beginning (included) and end (not included) of the index map. These numbers can be filled in the command of script `genFAMap.py` with a filename for the generated file like the case shown below:

```sh
python genFAMap.py -s 0 -e 347 -o 1r39_md_fa_g0a.map
```

The generated index maps are the same with identical input arguments of option `-s` and `-e`, which are used to specify the beginning (included) and end (not included) of the index map. Therefore, the generated index map `1r39_md_fa_g0a.map` can also be used for group B in the first analysis group pair, and groups in other analysis group pairs. For convenience, index map files are suggested to be renamed in a manner that all supported groups are listed in its name, like `1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map`.

Binary packed coordinate files are required when a reference system is needed, or the coordinate data is used for detailed analysis. For the first case, the reference system is used for rotation correction. Due to Brownian motion of solvent molecules, random collisions between water molecules and the protein molecule causing slow rotation of protein orientation during the sampling process. The summed forces on or pairwise forces between atoms or residues on protein are dependent on the coordinate system of protein orientations, while all force data is sampled under the Cartesian coordinate system of simulation box. The differences of coordinate systems in between result in difficult in analyzing force data as vectors, especially when the protein orientation based coordinate system is changing constantly throughout the sampled trajectory. By fitting the conformations of selected reference system, e.g., the protein itself, back to its initial conformation, vectors sampled under the the Cartesian coordinate system can be converted into protein orientation based coordinate system with a rotation operation. For convenience, the reference system at each frames is aligned to its conformation at $t = 0$, or the first recorded conformation in the given trajectory, and a series of rotation matrix $\mathbf{U}_t$ are derived by quaternion–based 3D rotation algorithm. The $\mathbf{U}_t$ is decided by minimizing RMSD between the aligned structure $\widetilde{\mathbf{R}}_t = \mathbf{U}_t \mathbf{R}_t + \mathbf{s}_t$ and initial structure $\mathbf{R}_0$, where $\mathbf{R}_t$ refers to the reference structure at time $t$, and $\mathbf{s}_t$ represents the translation shift vector of reference system. The rotation matrix $\mathbf{U}_t$ is used to derive the converted force vector $\widetilde{\mathbf{F}}_t = \mathbf{U}_t \mathbf{F}_t$.

For the second case, the coordinate data is used to determine the average positions of atoms or residues and the distances and shift vectors between these pairs. Taking Periodic Boundary Condition (PBC) into consideration is crucial in this case, inappropriate handling of PBC could cause terrible mistakes. The `gmx trjconv` command can be used to make molecules that are divided under PBC whole. For example, to unwrap a protein which is marked as index group `Protein`:

```sh
echo Protein | gmx trjconv -s 1r39_md_fa.tpr -f 1r39_md_fa.trr -n index.ndx -o frames/frame.pdb -sep -pbc whole
```

However, these results should be used with caution. For a protein-ligand complex, unwrap protein and ligand molecules separately could cause the distance bewteen protein and ligand undetermined. The ligand molecule might jump from one side of protein to the other when it is crossing the boundary. Thus coordinate data is not extracted in program automatically, but reserved for check manually.

For both cases mentioned above, a binary file format of packed coordinate was used. A script `collectFrames.py` is provided for packing hundreds of standalone PDB file into a binary file required. Assuming that PDB files of group `Protein` with filenames `frameX.pdb` (X denotes frame ID in the trajectory) are listed in `frame_pro` directory, calling `collectFrames.py` to collect coordinates of all protein atoms would be:

```sh
python collectFrames.py --workdir frame_pro/ --filename 1r39_md_fa_proatom --mode all
```

If Center of Mass (COM) of each residues are required, the command should be

```sh
python collectFrames.py --workdir frame_pro/ --filename 1r39_md_fa_prorescom --mode com
```

If PDB files of group `C-alpha` are listed in `frame_ca`, to collect coordinates of C-alpha in each protein residues:

```sh
python collectFrames.py --workdir frame_ca/ --filename 1r39_md_fa_proca --mode all
```

Since it is hard to view and check the stored data of a binary file, a script `unpackBinaryXYZ.py` is provided for unpacking binary packed coordinate file. Since there are too much data packed in a compact format, the printed output should be redirected to a file:

```sh
python unpackBinaryXYZ.py --file 1r39_md_fa_prorescom.xyz > 1r39_md_fa_prorescom_xyz.dat
```

#### Run Analysis Program

With force data files, index maps and packed coordinate files prepared, basic usage examples of `readFA` program are listed:

Analysis of pairwise force data `1r39_md_fa_grp0.for` of which protein residue-level internal force network is recorded:

```sh
readFA -f 1r39_md_fa_grp0.for \
-o 1r39_md_fa_presinfs.csv \
--map 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map \
--ref 1r39_md_fa_prorescom.xyz \
--coord 1r39_md_fa_prorescom.xyz 1r39_md_fa_prorescom.xyz \
--out all --out-digits 6
```

Running `readFA` successfully print the following information in the command-line interface:

```log
Got 347 nodes from mapping file 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map.
Successfully reading mapping data from file 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map.
Got 347 nodes from mapping file 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map.
Successfully reading mapping data from file 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map.
Got 10001 frames and 347 nodes from coordinate file 1r39_md_fa_prorescom.xyz.
Successfully reading coordinate data from file 1r39_md_fa_prorescom.xyz.
Got 10001 blocks in force data file.
Read frames in range from 0 (included) to 10001 (not included)
Got 10001 frames and 347 nodes from coordinate file 1r39_md_fa_prorescom.xyz.
Successfully reading coordinate data from file 1r39_md_fa_prorescom.xyz.
Average RMSD of fitted reference structures = 0.252 A.
Prerun stage for average forces.
Reading block     0, with force number =     20098
(10000 lines of reading blocks information omitted)

Reading forces for detailed analysis.
Reading block     0, with force number =     20098
(10000 lines of reading blocks information omitted)
Writing  series of force analysis results to file.
Assign edge weights according to FijProj
```

The digits in the shown logs may be different. Otherwise a runtime error is thrown out with detailed error information and the program interrupts.

Several CSV files formatted by separator comma (,) are generated by a successful running. To output files share the same tag `presinfs` which indicates the pattern of its analysis group pairs and is the short of "Protein RESidue-level INternal Force network Summed".

Analysis of pairwise force data `1r39_md_fa_grp1.for` of which protein residue-level internal force network with detailed potential components is recorded:

```sh
readFA -f 1r39_md_fa_grp1.for \
-o 1r39_md_fa_presinfd.csv \
--map 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map \
--ref 1r39_md_fa_prorescom.xyz \
--coord 1r39_md_fa_prorescom.xyz 1r39_md_fa_prorescom.xyz \
--out all --out-digits 6
```

Output tag `presinfd` is the short of "Protein RESidue-level INternal Force network Detailed". The word "Detailed" is used to mark a different analmode `detailed` is chosen. Output files are with different prefix to distinguish analsyis results from different detailed potential components. These prefix include bond, polar, angle, dihedral, 1-4, coulomb, vdw, and they correspond one-to-one with components from bonds, polar bonds, angles, dihedrals, 1-4 interactions, coulomb and LJ potentials, respectively. Force components from CMAP correction are added to dihedrals terms.

Analysis of pairwise force data `1r39_md_fa_grp2.for` of which protein C-alpha internal force network analysis is recorded:

```sh
readFA -f 1r39_md_fa_grp2.for \
-o 1r39_md_fa_pcaresinfs.csv \
--map 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map 1r39_md_fa_g0a+0b+1a+1b+2a+2b+5b.map \
--ref 1r39_md_fa_prorescom.xyz \
--coord 1r39_md_fa_proca.xyz 1r39_md_fa_prorescom.xyz \
--out all --out-digits 6
```

Output tag `pcaresinfs` is the short of "Protein C-Alpha RESidue INternal Force network Summed". Note that the first group of analysis group pairs is changed to `C-alpha` instead of `Protein`. The provided coordinate files must be in the same order, with coordinates from C-alpha `1r39_md_fa_proca.xyz` first and Protein `1r39_md_fa_prorescom.xyz` second.

Analysis of force data on atoms `1r39_md_fa.far`:

```sh
readFA -f 1r39_md_fa.far \
-o 1r39_md_fa_sysatom.csv \
--map 1r39_md_fa_sysatom.map 1r39_md_fa_sysatom.map \
--coord 1r39_md_fa_sysatom.xyz 1r39_md_fa_sysatom.xyz \
--out no-pairwise --out-digits 6 --no-crossanal
```

This file holds all atoms in simulation system, which is not configured by any analysis group pairs. A different index map file `1r39_md_fa_sysatom.map` (in this case generated with a map range from 0 to 71770) and a different binary coordinate file `1r39_md_fa_sysatom.xyz` (packed all coordinates of the whole system) are used. The rotation correction is off for not applicable. If you are interested in the protein region, a tool named `groupData` is compiled along with `readFA`, which can be used to truncate a large force data file. Here shows an example of usage:

```sh
groupData -f 1r39_md_fa.far -o 1r39_md_fa_patom.far -g 1r39_md_fa_g3b+4b.map
```

With an index map file `1r39_md_fa_g3b+4b.map` input (with a map range from 0 to 5598, or protein atoms indexes range), forces that are not in range of given index map are filtered out. The processed force data file only include forces on protein atoms, and forces on non-protein atoms (water molecules, ions, etc) are removed. Then it can be analyzed by `readFA` as follows:

```sh
readFA -f 1r39_md_fa_patom.far \
-o 1r39_md_fa_patom.csv \
--map 1r39_md_fa_g3b+4b.map 1r39_md_fa_g3b+4b.map \
--ref 1r39_md_fa_prorescom.xyz \
--coord 1r39_md_fa_proatom.xyz 1r39_md_fa_proatom.xyz \
--out no-pairwise --out-digits 6 --no-crossanal
```

Output tag `patom` is short of "Protein ATOM force". The same reference system of protein residue COM is used for consistency. The correlation analysis between every two different atoms is turned off for too slow and too much memory required.

#### Reading Results

The output results are listed as columns in CSV format tables. A complete descriptions of all possible results can be found in the documentation chapter of `readFA_documentation_240418.pdf`.

### PyMOL Visualization

#### Ellipsoids Representation in PyMOL

PyMOL supports drawing th anisotropic (ANISOU fields in the PDB record) thermal ellipsoids from high resolution structures. This function is used for drawing ellipsoids Representation of force or position fluctuations on atoms or residues in this case.

The ANISOU records in PDB format are used to present the anisotropic temperature factors. The detailed format table and requirements of ANISOU records can be accessed by visiting pages at [ANISOU records in PDB standard form](http://skuld.bmsc.washington.edu/parvati/pdb_anisou.html) and [PDB File Format - Contents Guide Version 3.30](https://www.wwpdb.org/documentation/file-format).

A script `addanisou.py` is provided for adding ANISOU records into a PDB file. Fluctuation of forces $\langle\Delta \mathbf{F}_i \Delta \mathbf{F}_i \rangle$ or positions $\langle\Delta \mathbf{R}_i \Delta \mathbf{R}_i \rangle$ of residues or atoms can be inserted. An example usage is shown below:

```sh
python addanisou.py --data 1r39_md_fa_presinfs_group1.csv --pdb 1r39_md_fa.pdb --type force --unit residue
```

The option `--data` accepts the proper pairwise force analysis result CSV file. Please check the data columns to confirm that `<DFiDFi>xx` or `<DRiDRi>xx` are in the header row. `--pdb` option specifies the PDB to be modified. The modification is not in place, but a new PDB file with an additional `anisou_` prefix is generated. `--type` and `--unit` options are used to determine the data types, where `--type` should be one of *force* or *coord*, `--unit` should be one of *atom* or *residue*.

With ANISOU records in PDB, the ellipsoids can be rendered by the following commands in PyMOL:

```python
show ellipsoids, all
set ellipsoid_quality, 3
set ellipsoid_scale, 0.5
set ellipsoid_transparency, 0.35
set ellipsoid_color, red
```

#### Force arrows plotted by Modevectors

`modevectors.py` is a PyMOL script that can be used to visualize the motion of two specified states, though it was originally developed to visualize Normal Mode Analysis results. The functionality of this script is not limited to draw displacement vectors from their beginnings pointing to their ends, it can also be used to draw force vectors in particular directions and lengths. The detailed description and usage are available at [Modevectors in PyMOLwiki](https://wiki.pymol.org/index.php/Modevectors).

#### Force cylinders plotted by DrawPairwiseForce

`modevectors.py` is a useful tool in visualization of vectors, highlighting the orientations and the norm sizes. However, it works bad when it is used to render too many vectors, for example, the characteristics of pairwise attractive or repulsive are difficult to observe. For a better visualization rendering of pairwise properites, we develop a PyMOL script `DrawPairwiseForce.py`, which can be used to visualize the residue interaction network within protein, and important interaction pairs between protein and ligand in protein-ligand complex studies.

This script is loaded using the `run` command (see [run in PyMOLwiki](https://wiki.pymol.org/index.php/Run) documentationn page). Then call the script with several custom options:

```python
draw_pairwise_force forcedata [,grpAunit = residue [,grpBunit = residue [,grpAoffset = 1 [,grpBoffset = 1 [,minforce = 100.0 [,grppairs = 200 [,mindseq = 1 [,width = 1.0]]]]]]]]
```

Of all input arguments, `forcedata` specifies the path of pairwise results CSV file with `<FijProj>` column to plot. The `grpAunit` and `grpBunit` can be one of atom / residue. If the pairwise forces are between residue pairs, both of `grpAunit` and `grpBunit` should be residue. If the pairwise forces are between atom - residue pairs (atom for group A and residue for group B), then `grpAunit` shoule be set to atom and `grpBunit` to be residue. `grpAoffset` and `grpBoffset` is used to adjust indexes recorded in each force pairs to that in PDB file. In this case, PDB file extracted from trajectory have missing residues in the head, and the first residue index begins at 5, while the first residue index recorded in force pairs begins at 0, thus an offset of 5 should be applied. The offset should be determined with caution, or the visualization results could be totally wrong.

`minforce` is used to filter small pairwise forces. This is important in improving visual effect, since there are too many pairwise forces, most of which are close to zero. Rendering all pairwise forces would result in the problem that the protein background is overwhelmed by too many objects in the front, associations between features of protein residues and pairwise forces are impossible to observe. `grppairs` is used to change how many pairwise force objects can be held in a group. These groups are listed in the right sidebar, so that you can easily choose to show or hide one of these groups by selecting or deselecting operations. `mindseq` is the option to filter pairwise forces that are close in indexes, for example, in a residue interaction network, usually those pairs connected by bonds are larger than others. You can filter these pairs by set `mindseq = 2` but keep these pairs by `mindseq = 1`. `mindseq = 0` will always be safe for it filters out nothing. `width` term is to configure the width of rendered cylinders. However, the colors are fixed in scripts, rendering the attractive pairs as red and repulsive pairs as blue.

This script is relied on `pandas` and `numpy`. It is fully tested within a python virtual environment with `python=3.9, pandas=1.5, numpy=1.23, pymol-open-source=2.5`. An example of using this script could be:

```python
draw_pairwise_force 1r39_md_fa_presinfs_pairwise.csv, grpAunit=residue, grpBunit=residue, grpAoffset=5, grpBoffset=5, minforce=100, grppairs=100, mindseq=1
```
